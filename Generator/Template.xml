<?xml version="1.0" encoding="utf-8"?>
<!--
  Base template for the generator.
  The generator replaces:
    SPECIALIZE
    FIRSTLOGON
    EMBEDDEDZIP
    WORKSPACE
-->

<unattend xmlns="urn:schemas-microsoft-com:unattend"
          xmlns:wcm="http://schemas.microsoft.com/WMIConfig/2002/State">

    <!-- Pass: offlineServicing
         Reserved for injecting drivers or packages into the image.
         Left empty intentionally. -->
    <settings pass="offlineServicing"></settings>

    <!-- Pass: windowsPE
         Runs before the OS image is applied.
         Good place for TPM/SB/RAM bypass and product key UI behavior. -->
    <settings pass="windowsPE">
        <component name="Microsoft-Windows-Setup"
                   processorArchitecture="amd64"
                   publicKeyToken="31bf3856ad364e35"
                   language="neutral"
                   versionScope="nonSxS">

            <ImageInstall>
                <OSImage>
                    <Compact>false</Compact>
                </OSImage>
            </ImageInstall>

            <UserData>
                <ProductKey>
                    <!-- Placeholder key; user can override -->
                    <Key>00000-00000-00000-00000-00000</Key>
                    <WillShowUI>Always</WillShowUI>
                </ProductKey>
                <AcceptEula>true</AcceptEula>
            </UserData>

            <UseConfigurationSet>false</UseConfigurationSet>

            <!-- TPM/SecureBoot/RAM bypass -->
            <RunSynchronous>
                <RunSynchronousCommand wcm:action="add">
                    <Order>1</Order>
                    <Path>reg.exe add "HKLM\SYSTEM\Setup\LabConfig" /v BypassTPMCheck /t REG_DWORD /d 1 /f</Path>
                </RunSynchronousCommand>
                <RunSynchronousCommand wcm:action="add">
                    <Order>2</Order>
                    <Path>reg.exe add "HKLM\SYSTEM\Setup\LabConfig" /v BypassSecureBootCheck /t REG_DWORD /d 1 /f</Path>
                </RunSynchronousCommand>
                <RunSynchronousCommand wcm:action="add">
                    <Order>3</Order>
                    <Path>reg.exe add "HKLM\SYSTEM\Setup\LabConfig" /v BypassRAMCheck /t REG_DWORD /d 1 /f</Path>
                </RunSynchronousCommand>
            </RunSynchronous>

        </component>
    </settings>

    <!-- Pass: generalize
         Runs during sysprep generalization.
         Not used by this generator. -->
    <settings pass="generalize"></settings>

    <!-- Pass: specialize
         Machine-level configuration.
         This is where the embedded ZIP is extracted. -->
    <settings pass="specialize">
        <component name="Microsoft-Windows-Deployment"
                   processorArchitecture="amd64"
                   publicKeyToken="31bf3856ad364e35"
                   language="neutral"
                   versionScope="nonSxS">

            <RunSynchronous>

                <!-- Extract embedded ZIP + files -->
                <RunSynchronousCommand wcm:action="add">
                    <Order>1</Order>
                    <Path>
                        powershell.exe -WindowStyle "Normal" -NoProfile -Command "$xml = [xml]::new(); $xml.Load('C:\Windows\Panther\unattend.xml'); $sb = [scriptblock]::Create( $xml.unattend.Extensions.ExtractScript ); Invoke-Command -ScriptBlock $sb -ArgumentList $xml;"
                    </Path>
                </RunSynchronousCommand>

                <!-- Bootstrap the embedded ZIP + create WORKSPACE -->
                <RunSynchronousCommand wcm:action="add">
                    <Order>2</Order>
                    <Path>
                        powershell.exe -ExecutionPolicy Bypass -File "C:\Windows\Setup\Scripts\Bootstrap.ps1"
                    </Path>
                </RunSynchronousCommand>

                <!-- Generator inserts specialize-phase commands here -->
                {{SPECIALIZE}}
                
                <!-- Configure Active Setup -->
                <RunSynchronousCommand wcm:action="add">
                    <Order>4</Order>
                    <Path>
                        powershell.exe -ExecutionPolicy Bypass -File "C:\Windows\Setup\Scripts\ActiveSetup.Config.ps1"
                    </Path>
                </RunSynchronousCommand>

            </RunSynchronous>

        </component>
    </settings>

    <!-- auditSystem / auditUser not used -->
    <settings pass="auditSystem"></settings>
    <settings pass="auditUser"></settings>

    <!-- Pass: oobeSystem
         User creation, first logon, Active Setup registration. -->
    <settings pass="oobeSystem">
        <component name="Microsoft-Windows-Shell-Setup"
                   processorArchitecture="amd64"
                   publicKeyToken="31bf3856ad364e35"
                   language="neutral"
                   versionScope="nonSxS">

            <OOBE>
                <ProtectYourPC>3</ProtectYourPC>
                <HideEULAPage>true</HideEULAPage>
                <HideWirelessSetupInOOBE>true</HideWirelessSetupInOOBE>
                <HideOnlineAccountScreens>true</HideOnlineAccountScreens>
            </OOBE>

            <!-- Generator inserts FirstLogonCommands here -->
            {{FIRSTLOGON}}

        </component>
    </settings>

    <!-- Custom extension block used by the generator -->
    <Extensions>

        <!-- PowerShell script that extracts embedded files -->
        <ExtractScript>
param(
    [xml] $Document
)

foreach ($file in $Document.unattend.Extensions.File) {
    $path = [System.Environment]::ExpandEnvironmentVariables($file.GetAttribute('path'))
    $ext  = [System.IO.Path]::GetExtension($path).ToLower()

    # Ensure parent directory exists
    $parent = Split-Path $path -Parent
    if ($parent) {
        mkdir -Path $parent -ErrorAction SilentlyContinue | Out-Null
    }

    if ($ext -in '.zip', '.exe', '.dll', '.msi') {
        # Binary-safe extraction
        $bytes = [Convert]::FromBase64String($file.InnerText.Trim())
        [System.IO.File]::WriteAllBytes($path, $bytes)
        continue
    }

    # Text-based extraction with encoding selection
    $encoding = switch ($ext) {
        '.ps1' { [System.Text.Encoding]::UTF8 }
        '.xml' { [System.Text.Encoding]::UTF8 }
        '.reg' { [System.Text.UnicodeEncoding]::new($false, $true) }
        '.vbs' { [System.Text.UnicodeEncoding]::new($false, $true) }
        '.js'  { [System.Text.UnicodeEncoding]::new($false, $true) }
        default { [System.Text.Encoding]::Default }
    }

    $bytes = $encoding.GetPreamble() + $encoding.GetBytes($file.InnerText.Trim())
    [System.IO.File]::WriteAllBytes($path, $bytes)
}
        </ExtractScript>
                
        <!-- Generator inserts WORKSPACE folder here -->
        <File path="C:\Windows\Setup\Scripts\Bootstrap.ps1">
<![CDATA[
& {
$workspace = "{{WORKSPACE}}"

if (-not (Test-Path $workspace)) {
    New-Item -Path $workspace -ItemType Directory -Force
}

Expand-Archive -Path "C:\Windows\Setup\Scripts\Build.zip" -DestinationPath $workspace -Force
} *>> "C:\Windows\Setup\Scripts\Bootstrap.log"
]]>
        </File>
        
        <File path="C:\Windows\Setup\Scripts\ActiveSetup.Config.ps1">
<![CDATA[
& {
New-Item -Path "HKLM:\Software\Microsoft\Active Setup\Installed Components\Autounattend" -Force
Set-ItemProperty -Path "HKLM:\Software\Microsoft\Active Setup\Installed Components\Autounattend" -Name Version -Value "1,0,0,0" -Type String
Set-ItemProperty -Path "HKLM:\Software\Microsoft\Active Setup\Installed Components\Autounattend" -Name StubPath -Value 'powershell.exe -ExecutionPolicy Bypass -File "{{WORKSPACE}}\ActiveSetup.ps1"' -Type String
Set-ItemProperty -Path "HKLM:\Software\Microsoft\Active Setup\Installed Components\Autounattend" -Name Locale -Value "*" -Type String
Set-ItemProperty -Path "HKLM:\Software\Microsoft\Active Setup\Installed Components\Autounattend" -Name IsInstalled -Value 1 -Type DWord
} *>> "C:\Windows\Setup\Scripts\ActiveSetup.Config.log"
]]>
        </File>
        
        <!-- Generator inserts embedded ZIP + file entries here -->
        {{EMBEDDEDZIP}}

    </Extensions>

</unattend>